#!/bin/bash

# host=$(rg '^Host\s+(.*)' ~/.ssh/config --no-heading | awk '{print $2}' | fzf --prompt="é€‰æ‹©è¿œç¨‹ä¸»æœº: ")
# [ -z "$host" ] && echo "âŒ æœªé€‰æ‹©ä¸»æœº" && return 1
#
# # é€‰æ‹©æœ¬åœ°æ–‡ä»¶/ç›®å½•ï¼ˆå¯å¤šé€‰ï¼‰
# local targets
# targets=$(fd . --type f --type d | fzf --multi --prompt="é€‰æ‹©è¦ä¸Šä¼ çš„æœ¬åœ°æ–‡ä»¶/ç›®å½•: " --preview 'if [[ -d {} ]]; then ls -la {}; else file {}; fi')
# [ -z "$targets" ] && echo "âŒ æœªé€‰æ‹©æ–‡ä»¶/ç›®å½•" && return 1
#
# # è¾“å…¥è¿œç¨‹ç›®å½•ï¼ˆé»˜è®¤ä¸ºè¿œç¨‹ç”¨æˆ·ä¸»ç›®å½•ï¼‰
# local remote_dir
# echo -n "ğŸ“ è¯·è¾“å…¥è¿œç¨‹ç›®å½•è·¯å¾„ [é»˜è®¤: home directory]: "
# read remote_dir
# remote_dir=${remote_dir:-.} # Use . to mean remote user's home directory
#
# echo "ğŸš€ ä¸Šä¼ ä¸­: $(echo $targets | tr '\n' ' ') â†’ $host:$remote_dir"
#
# # Process each target individually to avoid path issues
# local target
# while IFS= read -r target; do
#   if [ -n "$target" ]; then
#     rsync -avzPr --rsh=ssh "$target" "${host}:${remote_dir}/"
#   fi
# done <<<"$targets"

# é€‰æ‹©è¿œç¨‹ä¸»æœº
host=$(rg '^Host\s+(.*)' ~/.ssh/config --no-heading | awk '{print $2}' | fzf --prompt="é€‰æ‹©è¿œç¨‹ä¸»æœº: ")
[ -z "$host" ] && echo "âŒ æœªé€‰æ‹©ä¸»æœº" && return 1

# é€‰æ‹©æœ¬åœ°æ–‡ä»¶æˆ–ç›®å½•
file=$(fd . --max-depth 3 --hidden --follow --color=never |
  fzf --prompt="é€‰æ‹©è¦ä¸Šä¼ çš„æœ¬åœ°æ–‡ä»¶/ç›®å½•: " \
    --preview "ls -lh {}")
file="${file%%/}"
[ -z "$file" ] && echo "âŒ æœªé€‰æ‹©æ–‡ä»¶" && return 1

# è¯¢é—®è¿œç¨‹ä¿å­˜ç›®å½•
echo -n "ğŸ“‚ è¯·è¾“å…¥è¿œç¨‹ä¿å­˜ç›®å½• [é»˜è®¤: ~]: "
read remote_dir
remote_dir=${remote_dir:-~}

echo "â¬†ï¸ æ­£åœ¨ä¸Šä¼ : $file â†’ $host:$remote_dir"

# æ‰§è¡Œä¸Šä¼ 
rsync -avzPr "$file" "${host}:${remote_dir}/"
